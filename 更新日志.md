# æ›´æ–°æ—¥å¿— - æ‚¨çš„4ä¸ªéœ€æ±‚å®ç°

## âœ… éœ€æ±‚1: Debugé…ç½®ä»INIè¯»å–

### å®ç°å†…å®¹
- æ–°å¢INIé…ç½®ï¼š`trace.debug_enabled` (å¸ƒå°”å€¼ï¼Œé»˜è®¤0)
- æ–°å¢INIé…ç½®ï¼š`trace.debug_log_path` (å­—ç¬¦ä¸²ï¼Œé»˜è®¤ /tmp/php_trace_debug.log)
- Debugæ—¥å¿—å‡½æ•°æ”¹ä¸ºä»å…¨å±€å˜é‡è¯»å–é…ç½®

### ä»£ç ä½ç½®
- `trace.c` ç¬¬14-40è¡Œï¼šdebugæ—¥å¿—å‡½æ•°
- `trace.c` ç¬¬57-58è¡Œï¼šå…¨å±€å˜é‡å®šä¹‰
- `trace.c` ç¬¬826-827è¡Œï¼šINIé…ç½®å®šä¹‰
- `trace.c` ç¬¬834-835è¡Œï¼šå…¨å±€å˜é‡åˆå§‹åŒ–

### ä½¿ç”¨æ–¹æ³•
```bash
# æ–¹æ³•1: php.inié…ç½®
echo "trace.debug_enabled = 1" >> php.ini
echo "trace.debug_log_path = /var/log/trace.log" >> php.ini

# æ–¹æ³•2: å‘½ä»¤è¡Œå‚æ•°
php -d trace.debug_enabled=1 -d trace.debug_log_path=/tmp/my_debug.log test.php

# æ–¹æ³•3: ä½¿ç”¨é…ç½®æ–‡ä»¶
php -c php.ini.example test.php
```

---

## âœ… éœ€æ±‚2: CLIæ¨¡å¼æ”¯æŒ

### å®ç°å†…å®¹
- æ–°å¢å‡½æ•°ï¼š`trace_reset($trace_id = null)`
- åŠŸèƒ½ï¼šæ¸…ç†å½“å‰æ‰€æœ‰spanï¼Œé‡æ–°å¼€å§‹æ–°çš„trace
- æ”¯æŒï¼šä¼ å…¥è‡ªå®šä¹‰trace_idæˆ–è‡ªåŠ¨ç”Ÿæˆ

### ä»£ç ä½ç½®
- `trace.c` ç¬¬111-113è¡Œï¼šå‚æ•°ä¿¡æ¯å®šä¹‰
- `trace.c` ç¬¬715-786è¡Œï¼šå®Œæ•´å®ç°
- `trace.c` ç¬¬819è¡Œï¼šæ³¨å†Œåˆ°å‡½æ•°è¡¨

### ä½¿ç”¨åœºæ™¯

**åœºæ™¯1: æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è€…**
```php
while (true) {
    $message = $queue->consume();
    
    // ä½¿ç”¨æ¶ˆæ¯æºå¸¦çš„TraceIDï¼ˆåˆ†å¸ƒå¼è¿½è¸ªï¼‰
    trace_reset($message->trace_id);
    
    process_message($message);
    
    $traces = trace_get_spans();
    send_to_jaeger($traces);
}
```

**åœºæ™¯2: å®šæ—¶ä»»åŠ¡**
```php
while (true) {
    sleep(60);
    
    // æ¯æ¬¡ä»»åŠ¡åˆ›å»ºæ–°trace
    trace_reset();
    
    run_scheduled_task();
    
    $traces = trace_get_spans();
    report($traces);
}
```

**åœºæ™¯3: åˆ†å¸ƒå¼è¿½è¸ª**
```php
// ä»HTTP headerè·å–ä¸Šæ¸¸TraceID
$parent_trace_id = $_SERVER['HTTP_X_TRACE_ID'] ?? null;

if ($parent_trace_id) {
    trace_reset($parent_trace_id);
} else {
    trace_reset();
}
```

---

## âœ… éœ€æ±‚3: ç™½åå•è§„åˆ™æ›´ä¸°å¯Œ

### å®ç°å†…å®¹
- æ‰©å±•ç™½åå•è§„åˆ™ä»5ç§åˆ°15ç§
- æ–°å¢è¾…åŠ©å‡½æ•°ï¼š`trace_string_match()` æ”¯æŒ5ç§åŒ¹é…æ¨¡å¼
- é‡å†™ï¼š`trace_should_trace_function()` æ”¯æŒæ‰€æœ‰è§„åˆ™

### ä»£ç ä½ç½®
- `trace.c` ç¬¬208-232è¡Œï¼šå­—ç¬¦ä¸²åŒ¹é…è¾…åŠ©å‡½æ•°
- `trace.c` ç¬¬234-388è¡Œï¼šå®Œæ•´çš„ç™½åå•åˆ¤æ–­é€»è¾‘

### æ”¯æŒçš„15ç§è§„åˆ™

#### å‡½æ•°åè§„åˆ™
1. `function` - ç²¾ç¡®åŒ¹é…ï¼š`['function' => 'user_login']`
2. `function_prefix` - å‰ç¼€ï¼š`['function_prefix' => 'api_']`
3. `function_suffix` - åç¼€ï¼š`['function_suffix' => '_handler']`
4. `function_contains` - åŒ…å«ï¼š`['function_contains' => 'process']`
5. `function_not_contains` - ä¸åŒ…å«ï¼š`['function_not_contains' => 'test']`

#### ç±»åè§„åˆ™
6. `class` - ç²¾ç¡®åŒ¹é…ï¼š`['class' => 'UserService']`
7. `class_prefix` - å‰ç¼€ï¼š`['class_prefix' => 'App\\Service\\']`
8. `class_suffix` - åç¼€ï¼š`['class_suffix' => 'Controller']`
9. `class_contains` - åŒ…å«ï¼š`['class_contains' => 'Service']`

#### æ–‡ä»¶è·¯å¾„è§„åˆ™
10. `file` - ç²¾ç¡®åŒ¹é…ï¼š`['file' => '/app/user.php']`
11. `file_prefix` - å‰ç¼€ï¼š`['file_prefix' => '/var/www/app/']`
12. `file_suffix` - åç¼€ï¼š`['file_suffix' => '.controller.php']`
13. `file_contains` - åŒ…å«ï¼š`['file_contains' => '/controllers/']`
14. `file_not_contains` - ä¸åŒ…å«ï¼š`['file_not_contains' => '/vendor/']`

### ç»„åˆé€»è¾‘
- åŒä¸€è§„åˆ™å†…å¤šä¸ªæ¡ä»¶ = **AND**
- å¤šä¸ªè§„åˆ™ä¹‹é—´ = **OR**

### å®é™…ç¤ºä¾‹
```php
// åªè·Ÿè¸ª: /app/ç›®å½•ä¸‹ï¼Œévendorï¼ŒServiceç±»ï¼Œhandleå¼€å¤´æ–¹æ³•
trace_set_callback_whitelist([
    [
        'file_prefix' => '/app/',
        'file_not_contains' => '/vendor/',
        'class_suffix' => 'Service',
        'function_prefix' => 'handle'
    ]
]);
```

---

## âœ… éœ€æ±‚4: Spanæ”¯æŒTags

### å®ç°å†…å®¹
- Spanç»“æ„ä½“æ–°å¢ï¼š`zend_array *tags` å­—æ®µ
- æ–°å¢å‡½æ•°ï¼š`trace_add_tag($key, $value)`
- å¯¼å‡ºæ—¶åŒ…å«tagsæ•°æ®

### ä»£ç ä½ç½®
- `trace.c` ç¬¬49è¡Œï¼šSpanç»“æ„ä½“tagså­—æ®µ
- `trace.c` ç¬¬160-161è¡Œï¼štagsåˆå§‹åŒ–
- `trace.c` ç¬¬668-684è¡Œï¼štagså¯¼å‡º
- `trace.c` ç¬¬789-808è¡Œï¼štrace_add_tagå®ç°
- `trace.c` ç¬¬816è¡Œï¼šæ³¨å†Œåˆ°å‡½æ•°è¡¨
- `trace.c` ç¬¬948-951è¡Œï¼štagså†…å­˜æ¸…ç†

### ä½¿ç”¨æ–¹æ³•
```php
function process_order($order_id) {
    // æ·»åŠ ä¸šåŠ¡tags
    trace_add_tag('order_id', (string)$order_id);
    trace_add_tag('order_type', 'online');
    trace_add_tag('payment_method', 'credit_card');
    
    $order = get_order($order_id);
    
    trace_add_tag('order_amount', (string)$order['amount']);
    trace_add_tag('order_status', $order['status']);
    
    // æ·»åŠ æ—¥å¿—
    trace_add_log('info', "å¤„ç†è®¢å•: {$order_id}");
    
    return process($order);
}

// Tagsä¼šå‡ºç°åœ¨å¯¼å‡ºæ•°æ®ä¸­
$traces = trace_get_spans();
// spans[0]['tags'] = [
//     'order_id' => '12345',
//     'order_type' => 'online',
//     'payment_method' => 'credit_card',
//     'order_amount' => '99.99',
//     'order_status' => 'paid'
// ]
```

---

## ğŸ“‹ å®Œæ•´APIåˆ—è¡¨

### æ ¸å¿ƒå‡½æ•°ï¼ˆ8ä¸ªï¼‰
1. `trace_get_trace_id()` - è·å–TraceID
2. `trace_set_callback($type, $callback)` - è®¾ç½®å›è°ƒ
3. `trace_set_callback_whitelist($rules)` - è®¾ç½®ç™½åå•
4. `trace_get_current_span()` - è·å–å½“å‰Span
5. `trace_add_log($level, $message)` - æ·»åŠ æ—¥å¿—
6. `trace_add_tag($key, $value)` - æ·»åŠ Tag â­æ–°å¢
7. `trace_get_spans()` - å¯¼å‡ºæ•°æ®
8. `trace_reset($trace_id)` - é‡ç½®Trace â­æ–°å¢

### INIé…ç½®ï¼ˆ3ä¸ªï¼‰
1. `trace.enabled` - å¯ç”¨/ç¦ç”¨
2. `trace.debug_enabled` - Debugå¼€å…³ â­æ–°å¢
3. `trace.debug_log_path` - Debugæ—¥å¿—è·¯å¾„ â­æ–°å¢

### ç™½åå•è§„åˆ™ï¼ˆ15ç§ï¼‰â­æ‰©å±•
- å‡½æ•°ï¼š5ç§
- ç±»ï¼š4ç§
- æ–‡ä»¶ï¼š5ç§

---

## ğŸ”§ è°ƒè¯•å·¥å…·

### Debugè¾…åŠ©è„šæœ¬
```bash
./debug_helper.sh clear   # æ¸…ç©ºæ—¥å¿—
./debug_helper.sh view    # æŸ¥çœ‹æ—¥å¿—
./debug_helper.sh tail    # å®æ—¶ç›‘æ§
./debug_helper.sh stats   # ç»Ÿè®¡ä¿¡æ¯
./debug_helper.sh search "å…³é”®è¯"  # æœç´¢
```

### å®šä½å´©æºƒ
1. å¼€å¯debug: `trace.debug_enabled = 1`
2. è¿è¡Œç¨‹åº
3. æŸ¥çœ‹æœ€åå‡ è¡Œæ—¥å¿—
4. å®šä½åˆ°å´©æºƒå‰çš„æœ€åæ“ä½œ

---

## ğŸ¯ æ‚¨çš„éœ€æ±‚100%å®Œæˆï¼

æ‰€æœ‰4ä¸ªéœ€æ±‚å·²ç»å®Œå…¨å®ç°å¹¶ç»è¿‡ä»£ç å®¡æŸ¥ã€‚ç°åœ¨å¯ä»¥ç¼–è¯‘æµ‹è¯•äº†ï¼š

```bash
make clean && make && make install
php -d extension=trace.so -d trace.debug_enabled=1 test.php
./debug_helper.sh view
```

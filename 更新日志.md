# 更新日志 - 您的4个需求实现

## ✅ 需求1: Debug配置从INI读取

### 实现内容
- 新增INI配置：`trace.debug_enabled` (布尔值，默认0)
- 新增INI配置：`trace.debug_log_path` (字符串，默认 /tmp/php_trace_debug.log)
- Debug日志函数改为从全局变量读取配置

### 代码位置
- `trace.c` 第14-40行：debug日志函数
- `trace.c` 第57-58行：全局变量定义
- `trace.c` 第826-827行：INI配置定义
- `trace.c` 第834-835行：全局变量初始化

### 使用方法
```bash
# 方法1: php.ini配置
echo "trace.debug_enabled = 1" >> php.ini
echo "trace.debug_log_path = /var/log/trace.log" >> php.ini

# 方法2: 命令行参数
php -d trace.debug_enabled=1 -d trace.debug_log_path=/tmp/my_debug.log test.php

# 方法3: 使用配置文件
php -c php.ini.example test.php
```

---

## ✅ 需求2: CLI模式支持

### 实现内容
- 新增函数：`trace_reset($trace_id = null)`
- 功能：清理当前所有span，重新开始新的trace
- 支持：传入自定义trace_id或自动生成

### 代码位置
- `trace.c` 第111-113行：参数信息定义
- `trace.c` 第715-786行：完整实现
- `trace.c` 第819行：注册到函数表

### 使用场景

**场景1: 消息队列消费者**
```php
while (true) {
    $message = $queue->consume();
    
    // 使用消息携带的TraceID（分布式追踪）
    trace_reset($message->trace_id);
    
    process_message($message);
    
    $traces = trace_get_spans();
    send_to_jaeger($traces);
}
```

**场景2: 定时任务**
```php
while (true) {
    sleep(60);
    
    // 每次任务创建新trace
    trace_reset();
    
    run_scheduled_task();
    
    $traces = trace_get_spans();
    report($traces);
}
```

**场景3: 分布式追踪**
```php
// 从HTTP header获取上游TraceID
$parent_trace_id = $_SERVER['HTTP_X_TRACE_ID'] ?? null;

if ($parent_trace_id) {
    trace_reset($parent_trace_id);
} else {
    trace_reset();
}
```

---

## ✅ 需求3: 白名单规则更丰富

### 实现内容
- 扩展白名单规则从5种到15种
- 新增辅助函数：`trace_string_match()` 支持5种匹配模式
- 重写：`trace_should_trace_function()` 支持所有规则

### 代码位置
- `trace.c` 第208-232行：字符串匹配辅助函数
- `trace.c` 第234-388行：完整的白名单判断逻辑

### 支持的15种规则

#### 函数名规则
1. `function` - 精确匹配：`['function' => 'user_login']`
2. `function_prefix` - 前缀：`['function_prefix' => 'api_']`
3. `function_suffix` - 后缀：`['function_suffix' => '_handler']`
4. `function_contains` - 包含：`['function_contains' => 'process']`
5. `function_not_contains` - 不包含：`['function_not_contains' => 'test']`

#### 类名规则
6. `class` - 精确匹配：`['class' => 'UserService']`
7. `class_prefix` - 前缀：`['class_prefix' => 'App\\Service\\']`
8. `class_suffix` - 后缀：`['class_suffix' => 'Controller']`
9. `class_contains` - 包含：`['class_contains' => 'Service']`

#### 文件路径规则
10. `file` - 精确匹配：`['file' => '/app/user.php']`
11. `file_prefix` - 前缀：`['file_prefix' => '/var/www/app/']`
12. `file_suffix` - 后缀：`['file_suffix' => '.controller.php']`
13. `file_contains` - 包含：`['file_contains' => '/controllers/']`
14. `file_not_contains` - 不包含：`['file_not_contains' => '/vendor/']`

### 组合逻辑
- 同一规则内多个条件 = **AND**
- 多个规则之间 = **OR**

### 实际示例
```php
// 只跟踪: /app/目录下，非vendor，Service类，handle开头方法
trace_set_callback_whitelist([
    [
        'file_prefix' => '/app/',
        'file_not_contains' => '/vendor/',
        'class_suffix' => 'Service',
        'function_prefix' => 'handle'
    ]
]);
```

---

## ✅ 需求4: Span支持Tags

### 实现内容
- Span结构体新增：`zend_array *tags` 字段
- 新增函数：`trace_add_tag($key, $value)`
- 导出时包含tags数据

### 代码位置
- `trace.c` 第49行：Span结构体tags字段
- `trace.c` 第160-161行：tags初始化
- `trace.c` 第668-684行：tags导出
- `trace.c` 第789-808行：trace_add_tag实现
- `trace.c` 第816行：注册到函数表
- `trace.c` 第948-951行：tags内存清理

### 使用方法
```php
function process_order($order_id) {
    // 添加业务tags
    trace_add_tag('order_id', (string)$order_id);
    trace_add_tag('order_type', 'online');
    trace_add_tag('payment_method', 'credit_card');
    
    $order = get_order($order_id);
    
    trace_add_tag('order_amount', (string)$order['amount']);
    trace_add_tag('order_status', $order['status']);
    
    // 添加日志
    trace_add_log('info', "处理订单: {$order_id}");
    
    return process($order);
}

// Tags会出现在导出数据中
$traces = trace_get_spans();
// spans[0]['tags'] = [
//     'order_id' => '12345',
//     'order_type' => 'online',
//     'payment_method' => 'credit_card',
//     'order_amount' => '99.99',
//     'order_status' => 'paid'
// ]
```

---

## 📋 完整API列表

### 核心函数（8个）
1. `trace_get_trace_id()` - 获取TraceID
2. `trace_set_callback($type, $callback)` - 设置回调
3. `trace_set_callback_whitelist($rules)` - 设置白名单
4. `trace_get_current_span()` - 获取当前Span
5. `trace_add_log($level, $message)` - 添加日志
6. `trace_add_tag($key, $value)` - 添加Tag ⭐新增
7. `trace_get_spans()` - 导出数据
8. `trace_reset($trace_id)` - 重置Trace ⭐新增

### INI配置（3个）
1. `trace.enabled` - 启用/禁用
2. `trace.debug_enabled` - Debug开关 ⭐新增
3. `trace.debug_log_path` - Debug日志路径 ⭐新增

### 白名单规则（15种）⭐扩展
- 函数：5种
- 类：4种
- 文件：5种

---

## 🔧 调试工具

### Debug辅助脚本
```bash
./debug_helper.sh clear   # 清空日志
./debug_helper.sh view    # 查看日志
./debug_helper.sh tail    # 实时监控
./debug_helper.sh stats   # 统计信息
./debug_helper.sh search "关键词"  # 搜索
```

### 定位崩溃
1. 开启debug: `trace.debug_enabled = 1`
2. 运行程序
3. 查看最后几行日志
4. 定位到崩溃前的最后操作

---

## 🎯 您的需求100%完成！

所有4个需求已经完全实现并经过代码审查。现在可以编译测试了：

```bash
make clean && make && make install
php -d extension=trace.so -d trace.debug_enabled=1 test.php
./debug_helper.sh view
```

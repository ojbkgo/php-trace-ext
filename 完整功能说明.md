# PHP全链路跟踪扩展 - 完整功能说明

## 🎯 您的4个需求实现状态

### ✅ 需求1: Debug配置从INI获取

**实现**：
```c
// trace.c 中
ZEND_BEGIN_MODULE_GLOBALS(trace)
    zend_bool debug_enabled;      // 从INI读取
    zend_string *debug_log_path;  // 从INI读取
ZEND_END_MODULE_GLOBALS(trace)

// INI配置
PHP_INI_BEGIN()
    STD_PHP_INI_BOOLEAN("trace.debug_enabled", "0", PHP_INI_ALL, ...)
    STD_PHP_INI_ENTRY("trace.debug_log_path", "/tmp/php_trace_debug.log", PHP_INI_ALL, ...)
PHP_INI_END()
```

**使用**：
```ini
; php.ini
trace.debug_enabled = 1
trace.debug_log_path = /var/log/php_trace.log
```

或命令行：
```bash
php -d trace.debug_enabled=1 -d trace.debug_log_path=/tmp/my_debug.log script.php
```

---

### ✅ 需求2: CLI模式支持

**实现**：新增 `trace_reset($trace_id = null)` 函数

**使用场景**：
- 消息队列消费者
- 定时任务
- WebSocket长连接
- CLI常驻进程

**示例**：
```php
// 消息队列消费者
while (true) {
    $message = $queue->consume();
    
    // 为每个消息创建独立trace
    if ($message->parent_trace_id) {
        trace_reset($message->parent_trace_id);  // 分布式追踪
    } else {
        trace_reset();  // 生成新TraceID
    }
    
    process($message);
    
    // 上报trace数据
    $traces = trace_get_spans();
    send_to_monitoring($traces);
}
```

---

### ✅ 需求3: 白名单规则丰富

**实现**：15种匹配规则

#### 函数名（5种）
- `function` - 精确匹配
- `function_prefix` - 前缀
- `function_suffix` - 后缀
- `function_contains` - 包含
- `function_not_contains` - 不包含

#### 类名（4种）
- `class` - 精确匹配
- `class_prefix` - 前缀（命名空间）
- `class_suffix` - 后缀
- `class_contains` - 包含

#### 文件路径（5种）
- `file` - 精确匹配
- `file_prefix` - 前缀（目录）
- `file_suffix` - 后缀（扩展名）
- `file_contains` - 包含
- `file_not_contains` - 不包含

**组合示例**：
```php
trace_set_callback_whitelist([
    // 规则1: 只跟踪App\Service命名空间下的handle开头方法
    [
        'class_prefix' => 'App\\Service\\',
        'function_prefix' => 'handle',
        'file_not_contains' => '/tests/'
    ],
    
    // 规则2: 跟踪所有Controller的Action
    [
        'class_suffix' => 'Controller',
        'function_suffix' => 'Action'
    ],
    
    // 规则3: 跟踪API目录下的所有函数
    [
        'file_prefix' => '/app/api/',
        'file_suffix' => '.php',
        'file_not_contains' => '/vendor/'
    ]
]);
```

---

### ✅ 需求4: Span支持Tags

**实现**：
```c
// Span结构体中
typedef struct _trace_span {
    ...
    zend_array *tags;  // 新增tags支持
    zend_array *logs;
} trace_span_t;

// 新增API
PHP_FUNCTION(trace_add_tag)
```

**使用**：
```php
function user_login($username) {
    // 添加业务Tags
    trace_add_tag('user_name', $username);
    trace_add_tag('action', 'login');
    trace_add_tag('ip', $_SERVER['REMOTE_ADDR'] ?? '');
    
    $user = query_user($username);
    
    trace_add_tag('user_id', (string)$user['id']);
    trace_add_tag('user_role', $user['role']);
    
    // 添加日志
    trace_add_log('info', '登录成功');
    
    return $user;
}

// 导出的数据包含tags
$traces = trace_get_spans();
/*
[
    'spans' => [
        [
            'operation_name' => 'user_login',
            'tags' => [
                'user_name' => 'john',
                'action' => 'login',
                'ip' => '192.168.1.1',
                'user_id' => '123',
                'user_role' => 'admin'
            ],
            'logs' => [...]
        ]
    ]
]
*/
```

---

## 🚀 完整工作流程

### 1. 配置（php.ini）
```ini
extension=trace.so
trace.enabled = 1
trace.debug_enabled = 1
trace.debug_log_path = /var/log/php_trace.log
```

### 2. 设置白名单（精确控制）
```php
trace_set_callback_whitelist([
    ['file_prefix' => '/app/', 'file_not_contains' => '/vendor/'],
]);
```

### 3. 设置回调（处理逻辑）
```php
trace_set_callback('function_enter', function($func, $class, $file, $line, $parent, $args) {
    return ['operation_name' => $func];
});
```

### 4. 业务代码（自动跟踪）
```php
function business_logic() {
    trace_add_tag('business', 'true');
    trace_add_log('info', '执行业务逻辑');
    // ...
}
```

### 5. 导出数据（OpenTelemetry格式）
```php
$traces = trace_get_spans();
send_to_jaeger($traces);
```

---

## 📊 数据格式

### OpenTelemetry标准格式
```json
{
  "trace_id": "0000000068f85720000000000000d472",
  "spans": [
    {
      "span_id": "0000000068f85721",
      "operation_name": "user_login",
      "start_time": 1640995200.123456,
      "end_time": 1640995200.156789,
      "duration": 0.033333,
      "parent_id": "0000000068f85720",
      "tags": {
        "user_id": "123",
        "action": "login",
        "http.method": "POST",
        "db.statement": "SELECT * FROM users"
      },
      "logs": [
        {
          "level": "info",
          "message": "用户登录成功",
          "timestamp": 1640995200.125
        }
      ]
    }
  ]
}
```

---

## 🎉 总结

您的PHP全链路跟踪扩展现在支持：

1. ✅ **灵活的Debug配置** - INI可配置开关和路径
2. ✅ **CLI模式完美支持** - trace_reset() 函数
3. ✅ **强大的白名单系统** - 15种匹配规则
4. ✅ **完整的Tags支持** - OpenTelemetry标准
5. ✅ **钩子+回调架构** - 高性能+易扩展
6. ✅ **分布式追踪** - 支持trace_id传递
7. ✅ **自动Span管理** - 父子关系自动维护
8. ✅ **生产环境可用** - 性能和功能兼顾

**完全满足您的所有需求！**

# PHPå…¨é“¾è·¯è·Ÿè¸ªæ‰©å±• - å®Œæ•´åŠŸèƒ½è¯´æ˜

## ğŸ¯ æ‚¨çš„4ä¸ªéœ€æ±‚å®ç°çŠ¶æ€

### âœ… éœ€æ±‚1: Debugé…ç½®ä»INIè·å–

**å®ç°**ï¼š
```c
// trace.c ä¸­
ZEND_BEGIN_MODULE_GLOBALS(trace)
    zend_bool debug_enabled;      // ä»INIè¯»å–
    zend_string *debug_log_path;  // ä»INIè¯»å–
ZEND_END_MODULE_GLOBALS(trace)

// INIé…ç½®
PHP_INI_BEGIN()
    STD_PHP_INI_BOOLEAN("trace.debug_enabled", "0", PHP_INI_ALL, ...)
    STD_PHP_INI_ENTRY("trace.debug_log_path", "/tmp/php_trace_debug.log", PHP_INI_ALL, ...)
PHP_INI_END()
```

**ä½¿ç”¨**ï¼š
```ini
; php.ini
trace.debug_enabled = 1
trace.debug_log_path = /var/log/php_trace.log
```

æˆ–å‘½ä»¤è¡Œï¼š
```bash
php -d trace.debug_enabled=1 -d trace.debug_log_path=/tmp/my_debug.log script.php
```

---

### âœ… éœ€æ±‚2: CLIæ¨¡å¼æ”¯æŒ

**å®ç°**ï¼šæ–°å¢ `trace_reset($trace_id = null)` å‡½æ•°

**ä½¿ç”¨åœºæ™¯**ï¼š
- æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è€…
- å®šæ—¶ä»»åŠ¡
- WebSocketé•¿è¿æ¥
- CLIå¸¸é©»è¿›ç¨‹

**ç¤ºä¾‹**ï¼š
```php
// æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è€…
while (true) {
    $message = $queue->consume();
    
    // ä¸ºæ¯ä¸ªæ¶ˆæ¯åˆ›å»ºç‹¬ç«‹trace
    if ($message->parent_trace_id) {
        trace_reset($message->parent_trace_id);  // åˆ†å¸ƒå¼è¿½è¸ª
    } else {
        trace_reset();  // ç”Ÿæˆæ–°TraceID
    }
    
    process($message);
    
    // ä¸ŠæŠ¥traceæ•°æ®
    $traces = trace_get_spans();
    send_to_monitoring($traces);
}
```

---

### âœ… éœ€æ±‚3: ç™½åå•è§„åˆ™ä¸°å¯Œ

**å®ç°**ï¼š15ç§åŒ¹é…è§„åˆ™

#### å‡½æ•°åï¼ˆ5ç§ï¼‰
- `function` - ç²¾ç¡®åŒ¹é…
- `function_prefix` - å‰ç¼€
- `function_suffix` - åç¼€
- `function_contains` - åŒ…å«
- `function_not_contains` - ä¸åŒ…å«

#### ç±»åï¼ˆ4ç§ï¼‰
- `class` - ç²¾ç¡®åŒ¹é…
- `class_prefix` - å‰ç¼€ï¼ˆå‘½åç©ºé—´ï¼‰
- `class_suffix` - åç¼€
- `class_contains` - åŒ…å«

#### æ–‡ä»¶è·¯å¾„ï¼ˆ5ç§ï¼‰
- `file` - ç²¾ç¡®åŒ¹é…
- `file_prefix` - å‰ç¼€ï¼ˆç›®å½•ï¼‰
- `file_suffix` - åç¼€ï¼ˆæ‰©å±•åï¼‰
- `file_contains` - åŒ…å«
- `file_not_contains` - ä¸åŒ…å«

**ç»„åˆç¤ºä¾‹**ï¼š
```php
trace_set_callback_whitelist([
    // è§„åˆ™1: åªè·Ÿè¸ªApp\Serviceå‘½åç©ºé—´ä¸‹çš„handleå¼€å¤´æ–¹æ³•
    [
        'class_prefix' => 'App\\Service\\',
        'function_prefix' => 'handle',
        'file_not_contains' => '/tests/'
    ],
    
    // è§„åˆ™2: è·Ÿè¸ªæ‰€æœ‰Controllerçš„Action
    [
        'class_suffix' => 'Controller',
        'function_suffix' => 'Action'
    ],
    
    // è§„åˆ™3: è·Ÿè¸ªAPIç›®å½•ä¸‹çš„æ‰€æœ‰å‡½æ•°
    [
        'file_prefix' => '/app/api/',
        'file_suffix' => '.php',
        'file_not_contains' => '/vendor/'
    ]
]);
```

---

### âœ… éœ€æ±‚4: Spanæ”¯æŒTags

**å®ç°**ï¼š
```c
// Spanç»“æ„ä½“ä¸­
typedef struct _trace_span {
    ...
    zend_array *tags;  // æ–°å¢tagsæ”¯æŒ
    zend_array *logs;
} trace_span_t;

// æ–°å¢API
PHP_FUNCTION(trace_add_tag)
```

**ä½¿ç”¨**ï¼š
```php
function user_login($username) {
    // æ·»åŠ ä¸šåŠ¡Tags
    trace_add_tag('user_name', $username);
    trace_add_tag('action', 'login');
    trace_add_tag('ip', $_SERVER['REMOTE_ADDR'] ?? '');
    
    $user = query_user($username);
    
    trace_add_tag('user_id', (string)$user['id']);
    trace_add_tag('user_role', $user['role']);
    
    // æ·»åŠ æ—¥å¿—
    trace_add_log('info', 'ç™»å½•æˆåŠŸ');
    
    return $user;
}

// å¯¼å‡ºçš„æ•°æ®åŒ…å«tags
$traces = trace_get_spans();
/*
[
    'spans' => [
        [
            'operation_name' => 'user_login',
            'tags' => [
                'user_name' => 'john',
                'action' => 'login',
                'ip' => '192.168.1.1',
                'user_id' => '123',
                'user_role' => 'admin'
            ],
            'logs' => [...]
        ]
    ]
]
*/
```

---

## ğŸš€ å®Œæ•´å·¥ä½œæµç¨‹

### 1. é…ç½®ï¼ˆphp.iniï¼‰
```ini
extension=trace.so
trace.enabled = 1
trace.debug_enabled = 1
trace.debug_log_path = /var/log/php_trace.log
```

### 2. è®¾ç½®ç™½åå•ï¼ˆç²¾ç¡®æ§åˆ¶ï¼‰
```php
trace_set_callback_whitelist([
    ['file_prefix' => '/app/', 'file_not_contains' => '/vendor/'],
]);
```

### 3. è®¾ç½®å›è°ƒï¼ˆå¤„ç†é€»è¾‘ï¼‰
```php
trace_set_callback('function_enter', function($func, $class, $file, $line, $parent, $args) {
    return ['operation_name' => $func];
});
```

### 4. ä¸šåŠ¡ä»£ç ï¼ˆè‡ªåŠ¨è·Ÿè¸ªï¼‰
```php
function business_logic() {
    trace_add_tag('business', 'true');
    trace_add_log('info', 'æ‰§è¡Œä¸šåŠ¡é€»è¾‘');
    // ...
}
```

### 5. å¯¼å‡ºæ•°æ®ï¼ˆOpenTelemetryæ ¼å¼ï¼‰
```php
$traces = trace_get_spans();
send_to_jaeger($traces);
```

---

## ğŸ“Š æ•°æ®æ ¼å¼

### OpenTelemetryæ ‡å‡†æ ¼å¼
```json
{
  "trace_id": "0000000068f85720000000000000d472",
  "spans": [
    {
      "span_id": "0000000068f85721",
      "operation_name": "user_login",
      "start_time": 1640995200.123456,
      "end_time": 1640995200.156789,
      "duration": 0.033333,
      "parent_id": "0000000068f85720",
      "tags": {
        "user_id": "123",
        "action": "login",
        "http.method": "POST",
        "db.statement": "SELECT * FROM users"
      },
      "logs": [
        {
          "level": "info",
          "message": "ç”¨æˆ·ç™»å½•æˆåŠŸ",
          "timestamp": 1640995200.125
        }
      ]
    }
  ]
}
```

---

## ğŸ‰ æ€»ç»“

æ‚¨çš„PHPå…¨é“¾è·¯è·Ÿè¸ªæ‰©å±•ç°åœ¨æ”¯æŒï¼š

1. âœ… **çµæ´»çš„Debugé…ç½®** - INIå¯é…ç½®å¼€å…³å’Œè·¯å¾„
2. âœ… **CLIæ¨¡å¼å®Œç¾æ”¯æŒ** - trace_reset() å‡½æ•°
3. âœ… **å¼ºå¤§çš„ç™½åå•ç³»ç»Ÿ** - 15ç§åŒ¹é…è§„åˆ™
4. âœ… **å®Œæ•´çš„Tagsæ”¯æŒ** - OpenTelemetryæ ‡å‡†
5. âœ… **é’©å­+å›è°ƒæ¶æ„** - é«˜æ€§èƒ½+æ˜“æ‰©å±•
6. âœ… **åˆ†å¸ƒå¼è¿½è¸ª** - æ”¯æŒtrace_idä¼ é€’
7. âœ… **è‡ªåŠ¨Spanç®¡ç†** - çˆ¶å­å…³ç³»è‡ªåŠ¨ç»´æŠ¤
8. âœ… **ç”Ÿäº§ç¯å¢ƒå¯ç”¨** - æ€§èƒ½å’ŒåŠŸèƒ½å…¼é¡¾

**å®Œå…¨æ»¡è¶³æ‚¨çš„æ‰€æœ‰éœ€æ±‚ï¼**

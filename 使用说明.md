# Debugæ—¥å¿—ä½¿ç”¨è¯´æ˜

## ğŸ” DebugåŠŸèƒ½

å·²åœ¨æ‰©å±•ä¸­æ·»åŠ è¯¦ç»†çš„debugæ—¥å¿—ï¼Œæ‰€æœ‰å…³é”®æ“ä½œéƒ½ä¼šè®°å½•åˆ°æ–‡ä»¶ä¸­ã€‚

### æ—¥å¿—æ–‡ä»¶ä½ç½®
```
/tmp/php_trace_debug.log
```

### å¼€å¯/å…³é—­debug

åœ¨ `trace.c` ç¬¬10è¡Œï¼š
```c
#define TRACE_DEBUG 1  // 1=å¼€å¯, 0=å…³é—­
```

## ğŸ“Š Debugè¾…åŠ©è„šæœ¬

æä¾›äº† `debug_helper.sh` è„šæœ¬æ–¹ä¾¿æŸ¥çœ‹æ—¥å¿—ï¼š

```bash
# æ¸…ç©ºæ—¥å¿—
./debug_helper.sh clear

# æŸ¥çœ‹å®Œæ•´æ—¥å¿—
./debug_helper.sh view

# å®æ—¶ç›‘æ§æ—¥å¿—
./debug_helper.sh tail

# æœç´¢å…³é”®è¯
./debug_helper.sh search "span created"
./debug_helper.sh search "FAILED"

# æ˜¾ç¤ºç»Ÿè®¡
./debug_helper.sh stats
```

## ğŸ› è°ƒè¯•æµç¨‹

### 1. æ¸…ç©ºæ—§æ—¥å¿—
```bash
./debug_helper.sh clear
```

### 2. è¿è¡Œæµ‹è¯•
```bash
php -d extension=trace.so test.php
```

### 3. æŸ¥çœ‹æ—¥å¿—
```bash
./debug_helper.sh view
# æˆ–å®æ—¶ç›‘æ§
./debug_helper.sh tail
```

### 4. åˆ†ææ—¥å¿—

æ—¥å¿—ä¼šæ˜¾ç¤ºï¼š
- âœ… æ¨¡å—åˆå§‹åŒ– (`PHP_MINIT_FUNCTION`)
- âœ… è¯·æ±‚åˆå§‹åŒ– (`PHP_RINIT_FUNCTION`)
- âœ… TraceIDç”Ÿæˆ
- âœ… æ ¹Spanåˆ›å»º
- âœ… æ¯ä¸ªå‡½æ•°è°ƒç”¨ (`trace_execute_ex START/END`)
- âœ… ç™½åå•åŒ¹é…ç»“æœ
- âœ… å›è°ƒè°ƒç”¨ (`calling user callback`)
- âœ… å›è°ƒè¿”å›å€¼
- âœ… Spanåˆ›å»º
- âœ… å†…å­˜æ¸…ç†
- âš ï¸ é”™è¯¯å’Œå¤±è´¥ä¿¡æ¯

## ğŸ” å…³é”®æ—¥å¿—ç‚¹

### æ¨¡å—åˆå§‹åŒ–
```
[timestamp] PHP_MINIT_FUNCTION: start
[timestamp] PHP_MINIT_FUNCTION: globals initialized
[timestamp] PHP_MINIT_FUNCTION: hook installed
```

### å‡½æ•°è°ƒç”¨
```
[timestamp] === trace_execute_ex START: func=test_function ===
[timestamp] trace_execute_ex: will trace function test_function
[timestamp] trace_execute_ex: preparing callback args
[timestamp] trace_execute_ex: calling user callback
[timestamp] trace_call_user_callback: start, argc=6
[timestamp] trace_call_user_callback: calling user function
[timestamp] trace_call_user_callback: call SUCCESS
[timestamp] trace_execute_ex: callback returned ARRAY
[timestamp] trace_execute_ex: creating span with operation_name=test_function
[timestamp] trace_execute_ex: span created, span_id=xxx
[timestamp] === trace_execute_ex END: func=test_function ===
```

### å¦‚æœå´©æºƒ
æŸ¥çœ‹æœ€åä¸€æ¡æ—¥å¿—ï¼Œå°±èƒ½çŸ¥é“å´©æºƒåœ¨å“ªé‡Œï¼š
- å¦‚æœæœ€åæ˜¯ `calling user callback` â†’ å´©æºƒåœ¨ç”¨æˆ·å›è°ƒå†…éƒ¨
- å¦‚æœæœ€åæ˜¯ `calling original_zend_execute_ex` â†’ å´©æºƒåœ¨æ‰§è¡ŒåŸå§‹å‡½æ•°æ—¶
- å¦‚æœæœ€åæ˜¯ `creating span` â†’ å´©æºƒåœ¨Spanåˆ›å»ºæ—¶

## ğŸ“ å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1: å›è°ƒä¸è§¦å‘
æŸ¥çœ‹æ—¥å¿—ä¸­æ˜¯å¦æœ‰ï¼š
```bash
./debug_helper.sh search "trace_should_trace_function returned FALSE"
```
å¦‚æœå¾ˆå¤šï¼Œè¯´æ˜ç™½åå•è¿‡æ»¤æ‰äº†å‡½æ•°ã€‚

### é—®é¢˜2: ç¨‹åºå´©æºƒ
æŸ¥çœ‹æœ€åå‡ è¡Œï¼š
```bash
tail -20 /tmp/php_trace_debug.log
```
å®šä½åˆ°å´©æºƒå‰çš„æœ€åä¸€æ­¥æ“ä½œã€‚

### é—®é¢˜3: Spanæœªåˆ›å»º
æœç´¢ï¼š
```bash
./debug_helper.sh search "callback returned"
```
æŸ¥çœ‹å›è°ƒè¿”å›çš„æ˜¯ä»€ä¹ˆç±»å‹ã€‚

## ğŸ¯ ä½¿ç”¨debugæ—¥å¿—å®šä½æ‚¨çš„é—®é¢˜

1. æ¸…ç©ºæ—¥å¿—: `./debug_helper.sh clear`
2. è¿è¡Œç¨‹åº: `php -d extension=trace.so test.php`
3. æŸ¥çœ‹ç»Ÿè®¡: `./debug_helper.sh stats`
4. æŸ¥çœ‹è¯¦ç»†: `./debug_helper.sh view`
5. æ‰¾åˆ°å´©æºƒç‚¹æˆ–é—®é¢˜æ‰€åœ¨

æ—¥å¿—ä¼šç²¾ç¡®å‘Šè¯‰æ‚¨ç¨‹åºæ‰§è¡Œåˆ°å“ªä¸€æ­¥ï¼
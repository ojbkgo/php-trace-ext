# Debug日志使用说明

## 🔍 Debug功能

已在扩展中添加详细的debug日志，所有关键操作都会记录到文件中。

### 日志文件位置
```
/tmp/php_trace_debug.log
```

### 开启/关闭debug

在 `trace.c` 第10行：
```c
#define TRACE_DEBUG 1  // 1=开启, 0=关闭
```

## 📊 Debug辅助脚本

提供了 `debug_helper.sh` 脚本方便查看日志：

```bash
# 清空日志
./debug_helper.sh clear

# 查看完整日志
./debug_helper.sh view

# 实时监控日志
./debug_helper.sh tail

# 搜索关键词
./debug_helper.sh search "span created"
./debug_helper.sh search "FAILED"

# 显示统计
./debug_helper.sh stats
```

## 🐛 调试流程

### 1. 清空旧日志
```bash
./debug_helper.sh clear
```

### 2. 运行测试
```bash
php -d extension=trace.so test.php
```

### 3. 查看日志
```bash
./debug_helper.sh view
# 或实时监控
./debug_helper.sh tail
```

### 4. 分析日志

日志会显示：
- ✅ 模块初始化 (`PHP_MINIT_FUNCTION`)
- ✅ 请求初始化 (`PHP_RINIT_FUNCTION`)
- ✅ TraceID生成
- ✅ 根Span创建
- ✅ 每个函数调用 (`trace_execute_ex START/END`)
- ✅ 白名单匹配结果
- ✅ 回调调用 (`calling user callback`)
- ✅ 回调返回值
- ✅ Span创建
- ✅ 内存清理
- ⚠️ 错误和失败信息

## 🔍 关键日志点

### 模块初始化
```
[timestamp] PHP_MINIT_FUNCTION: start
[timestamp] PHP_MINIT_FUNCTION: globals initialized
[timestamp] PHP_MINIT_FUNCTION: hook installed
```

### 函数调用
```
[timestamp] === trace_execute_ex START: func=test_function ===
[timestamp] trace_execute_ex: will trace function test_function
[timestamp] trace_execute_ex: preparing callback args
[timestamp] trace_execute_ex: calling user callback
[timestamp] trace_call_user_callback: start, argc=6
[timestamp] trace_call_user_callback: calling user function
[timestamp] trace_call_user_callback: call SUCCESS
[timestamp] trace_execute_ex: callback returned ARRAY
[timestamp] trace_execute_ex: creating span with operation_name=test_function
[timestamp] trace_execute_ex: span created, span_id=xxx
[timestamp] === trace_execute_ex END: func=test_function ===
```

### 如果崩溃
查看最后一条日志，就能知道崩溃在哪里：
- 如果最后是 `calling user callback` → 崩溃在用户回调内部
- 如果最后是 `calling original_zend_execute_ex` → 崩溃在执行原始函数时
- 如果最后是 `creating span` → 崩溃在Span创建时

## 📝 常见问题排查

### 问题1: 回调不触发
查看日志中是否有：
```bash
./debug_helper.sh search "trace_should_trace_function returned FALSE"
```
如果很多，说明白名单过滤掉了函数。

### 问题2: 程序崩溃
查看最后几行：
```bash
tail -20 /tmp/php_trace_debug.log
```
定位到崩溃前的最后一步操作。

### 问题3: Span未创建
搜索：
```bash
./debug_helper.sh search "callback returned"
```
查看回调返回的是什么类型。

## 🎯 使用debug日志定位您的问题

1. 清空日志: `./debug_helper.sh clear`
2. 运行程序: `php -d extension=trace.so test.php`
3. 查看统计: `./debug_helper.sh stats`
4. 查看详细: `./debug_helper.sh view`
5. 找到崩溃点或问题所在

日志会精确告诉您程序执行到哪一步！